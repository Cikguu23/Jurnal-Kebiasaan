<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal 7 Kebiasaan Anak Indonesia Hebat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        // -- Kredensial Supabase Anda --
        const supabaseUrl = 'https://owgdgidtoupnxhgfybzv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93Z2RnaWR0b3VwbnhoZ2Z5Ynp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDIwODcsImV4cCI6MjA3MDQxODA4N30.Q0d6spUFdk0fKs0Dpm5qCzYEv5p5aN8Khn7oK5mzkVA';

        // Inisialisasi Supabase
        const { createClient } = window.supabase;
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // Membuat klien Supabase tersedia secara global
        window.supabase = supabase;
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #22c55e 0%, #fb923c 100%);
        }
        
        .habit-card {
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        
        .habit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .habit-card:nth-child(2) { animation-delay: 0.5s; }
        .habit-card:nth-child(3) { animation-delay: 1s; }
        .habit-card:nth-child(4) { animation-delay: 1.5s; }
        .habit-card:nth-child(5) { animation-delay: 2s; }
        .habit-card:nth-child(6) { animation-delay: 2.5s; }
        .habit-card:nth-child(7) { animation-delay: 3s; }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .notification {
            animation: slideIn 0.5s ease, fadeOut 0.5s ease 3.5s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gaya Modal */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white/10 backdrop-blur-md shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                 <img src="https://iili.io/FLZp1qP.md.png" alt="Logo Kiri" class="h-12 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/50x50/FFFFFF/000000?text=Logo';">
            </div>
            <h1 class="text-white text-lg md:text-xl font-bold text-center flex-1">Jurnal 7 Kebiasaan Anak Hebat</h1>
            <img src="https://iili.io/FLmkjSI.png" alt="Logo Sekolah" class="h-12 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/50x50/FFFFFF/000000?text=Logo';">
        </div>
    </header>

    <!-- Kontainer Utama -->
    <div class="container mx-auto px-4 py-8">
        <!-- Bagian Login -->
        <div id="loginSection" class="max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Masuk ke Jurnal</h2>
                <p class="text-gray-600">Pilih peran Anda untuk melanjutkan</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showStudentLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                    üéì Masuk sebagai Siswa
                </button>
                <button onclick="showTeacherLogin()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                    üë®‚Äçüè´ Masuk sebagai Guru
                </button>
            </div>
        </div>

        <!-- Formulir Login Siswa -->
        <div id="studentLoginForm" class="hidden max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Login Siswa</h3>
            <form onsubmit="studentLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Siswa</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kelas</label>
                    <select id="studentClass" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                         <option value="">Pilih Kelas</option>
                         <option value="1A">1A</option><option value="1B">1B</option><option value="1C">1C</option>
                         <option value="2A">2A</option><option value="2B">2B</option><option value="2C">2C</option><option value="2D">2D</option>
                         <option value="3A">3A</option><option value="3B">3B</option><option value="3C">3C</option><option value="3D">3D</option>
                         <option value="4A">4A</option><option value="4B">4B</option><option value="4C">4C</option><option value="4D">4D</option>
                         <option value="5A">5A</option><option value="5B">5B</option><option value="5C">5C</option>
                         <option value="6A">6A</option><option value="6B">6B</option><option value="6C">6C</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kode Unik Siswa (opsional)</label>
                    <input type="text" id="studentCode" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" placeholder="Untuk sinkronisasi antar perangkat">
                    <p class="text-xs text-gray-500 mt-1">Jika sudah pernah login, masukkan kode unik yang sama.</p>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <span class="loading-spinner hidden"></span>
                    Masuk
                </button>
                <button type="button" onclick="backToMain()" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Kembali
                </button>
            </form>
        </div>

        <!-- Formulir Login Guru -->
        <div id="teacherLoginForm" class="hidden max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Login Guru</h3>
            <form onsubmit="teacherLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Guru</label>
                    <input type="text" id="teacherName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="teacherPassword" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kelas yang Diampu</label>
                    <select id="teacherClass" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                        <option value="">Pilih Kelas</option>
                         <option value="1A">1A</option><option value="1B">1B</option><option value="1C">1C</option>
                         <option value="2A">2A</option><option value="2B">2B</option><option value="2C">2C</option><option value="2D">2D</option>
                         <option value="3A">3A</option><option value="3B">3B</option><option value="3C">3C</option><option value="3D">3D</option>
                         <option value="4A">4A</option><option value="4B">4B</option><option value="4C">4C</option><option value="4D">4D</option>
                         <option value="5A">5A</option><option value="5B">5B</option><option value="5C">5C</option>
                         <option value="6A">6A</option><option value="6B">6B</option><option value="6C">6C</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <span class="loading-spinner hidden"></span>
                    Masuk
                </button>
                <button type="button" onclick="backToMain()" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Kembali
                </button>
            </form>
        </div>

        <!-- Tampilan 7 Kebiasaan -->
        <div id="habitsDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Kartu kebiasaan dibuat secara dinamis -->
        </div>

        <!-- Dasbor Siswa -->
        <div id="studentDashboard" class="hidden">
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Dashboard Siswa</h2>
                    <button onclick="logout()" class="w-full md:w-auto bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">
                        Keluar
                    </button>
                </div>
                
                <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Halo, <span id="currentStudentName"></span>!</h3>
                    <p class="text-gray-600">Kelas: <span id="currentStudentClass"></span></p>
                    <p class="text-sm text-blue-600">Kode Unik Anda: <span id="currentStudentCode" class="font-mono bg-blue-100 px-2 py-1 rounded"></span> <button onclick="copyCode()" class="ml-2 text-xs">(Salin)</button></p>
                     <p class="text-xs text-gray-500 mt-1">Simpan kode ini untuk login di perangkat lain.</p>
                </div>

                <!-- Progress Bar -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Progress Minggu Ini</span>
                        <span class="text-sm font-medium text-gray-700" id="weeklyProgress">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Formulir Kebiasaan Harian -->
                <form id="habitsForm" onsubmit="saveHabits(event)">
                    <h3 class="text-xl font-bold mb-4">Jurnal Hari Ini - <span id="currentDate"></span></h3>
                    
                    <!-- Input kebiasaan dibuat secara dinamis -->
                    <div id="studentHabitInputs" class="space-y-4"></div>

                    <!-- Catatan Tambahan -->
                    <div class="mb-6 mt-6">
                        <label class="block text-lg font-semibold mb-2">üìù Catatan Tambahan</label>
                        <textarea id="additionalNotes" rows="3" class="w-full px-3 py-2 border rounded-lg" placeholder="Ceritakan pengalaman atau kebaikan yang kamu lakukan hari ini..."></textarea>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                        üíæ Simpan Jurnal Hari Ini
                    </button>
                </form>

                <!-- Riwayat Siswa -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">üìä Riwayat Pengisian (7 Hari Terakhir)</h3>
                    <div id="studentHistory" class="space-y-4">
                        <!-- Riwayat akan diisi di sini -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dasbor Guru -->
        <div id="teacherDashboard" class="hidden">
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-6 md:p-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                     <div>
                        <h2 class="text-2xl font-bold text-gray-800">Dashboard Guru</h2>
                        <p class="text-gray-600">Data diperbarui secara real-time.</p>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-4 md:mt-0">
                         <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üìä Export Excel
                        </button>
                        <button onclick="exportToPDF()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üìÑ Export PDF
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            Keluar
                        </button>
                    </div>
                </div>
                
                <div class="mb-6 bg-green-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Selamat datang, <span id="currentTeacherName"></span>!</h3>
                    <p class="text-gray-600">Memantau Kelas: <span id="currentTeacherClass" class="font-bold"></span></p>
                </div>

                <!-- Kartu Statistik -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <div class="bg-blue-100 p-4 rounded-lg text-center"><h4 class="font-semibold text-blue-800">Total Siswa</h4><p class="text-3xl font-bold text-blue-600" id="totalStudents">0</p></div>
                    <div class="bg-green-100 p-4 rounded-lg text-center"><h4 class="font-semibold text-green-800">Aktif Hari Ini</h4><p class="text-3xl font-bold text-green-600" id="activeToday">0</p></div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center"><h4 class="font-semibold text-yellow-800">Rata-rata Skor</h4><p class="text-3xl font-bold text-yellow-600" id="averageScore">0</p></div>
                    <div class="bg-purple-100 p-4 rounded-lg text-center"><h4 class="font-semibold text-purple-800">Konsistensi</h4><p class="text-3xl font-bold text-purple-600" id="consistency">0%</p></div>
                </div>

                <!-- Grafik -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-4">üìà Grafik Progress Kelas (7 Hari Terakhir)</h3>
                    <div class="bg-white p-4 rounded-lg shadow-inner">
                        <canvas id="classChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Tabel Siswa -->
                <div class="overflow-x-auto">
                    <h3 class="text-xl font-bold mb-4">üìã Data Siswa Hari Ini (<span id="todayDateForTable"></span>)</h3>
                    <table class="w-full bg-white rounded-lg overflow-hidden shadow-lg">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nama Siswa</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Skor</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Bangun Pagi</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Beribadah</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Olahraga</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Makan Sehat</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Belajar</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Bermasyarakat</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider hidden md:table-cell">Tidur Cepat</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Baris tabel akan diisi di sini -->
                        </tbody>
                    </table>
                </div>

                <!-- Papan Peringkat -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">üèÜ Papan Peringkat Mingguan</h3>
                    <div id="leaderboard" class="bg-white rounded-lg p-4 shadow-inner">
                        <!-- Papan peringkat akan diisi di sini -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifikasi -->
    <div id="notification" class="hidden fixed top-20 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <span id="notificationText"></span>
    </div>

    <!-- Modal Detail -->
    <div id="detailModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-white rounded-2xl p-6 md:p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Detail Jurnal</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modalBody" class="text-gray-700 space-y-4">
                <!-- Konten modal di sini -->
            </div>
             <button onclick="closeModal()" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                Tutup
            </button>
        </div>
    </div>


    <script>
        // --- STATE GLOBAL & KONSTANTA ---
        let currentUser = null;
        let userRole = null;
        let realtimeChannel = null; // Untuk menampung channel langganan realtime
        let classChart = null; // Untuk menampung instance grafik

        const HABITS = [
            { id: 1, name: 'Bangun Pagi', emoji: 'üåÖ', color: 'yellow', details: 'time', detailLabel: 'Jam bangun' },
            { id: 2, name: 'Beribadah', emoji: 'ü§≤', color: 'blue', details: 'prayer', detailLabel: 'Detail Ibadah' },
            { id: 3, name: 'Berolahraga', emoji: 'üèÉ‚Äç‚ôÇÔ∏è', color: 'green', details: 'text', detailLabel: 'Jenis olahraga' },
            { id: 4, name: 'Makan Sehat', emoji: 'ü•ó', color: 'orange', details: 'text', detailLabel: 'Menu yang dimakan' },
            { id: 5, name: 'Gemar Belajar', emoji: 'üìö', color: 'purple', details: 'text', detailLabel: 'Materi yang dipelajari' },
            { id: 6, name: 'Bermasyarakat', emoji: 'ü§ù', color: 'pink', details: 'text', detailLabel: 'Kegiatan sosial' },
            { id: 7, name: 'Tidur Cepat', emoji: 'üò¥', color: 'indigo', details: 'time', detailLabel: 'Jam tidur' }
        ];

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            renderHabitCards();
            renderStudentHabitInputs();
            checkSession();
        });

        function renderHabitCards() {
            const container = document.getElementById('habitsDisplay');
            container.innerHTML = HABITS.map(habit => `
                <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                    <div class="text-6xl mb-4">${habit.emoji}</div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${habit.name}</h3>
                </div>
            `).join('');
        }

        function renderStudentHabitInputs() {
            const container = document.getElementById('studentHabitInputs');
            container.innerHTML = HABITS.map(habit => {
                let detailInput = '';
                if (habit.details === 'time') {
                    detailInput = `<input type="time" id="detail${habit.id}" class="ml-8 px-3 py-1 border rounded w-auto"> <label class="ml-2 text-sm text-gray-600">${habit.detailLabel}</label>`;
                } else if (habit.details === 'text') {
                    detailInput = `<input type="text" id="detail${habit.id}" placeholder="${habit.detailLabel}" class="ml-8 px-3 py-1 border rounded w-full max-w-md">`;
                } else if (habit.details === 'prayer') {
                    detailInput = `
                        <div class="ml-8 space-y-2">
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                                ${['Subuh', 'Dzuhur', 'Ashar', 'Maghrib', 'Isya'].map(p => `
                                <label class="flex items-center"><input type="checkbox" class="prayer-check mr-2" data-prayer="${p.toLowerCase()}"><span class="text-sm">${p}</span></label>
                                `).join('')}
                            </div>
                            <input type="text" id="detail${habit.id}" placeholder="Keterangan tambahan (tahfiz, dll.)" class="w-full px-3 py-1 border rounded mt-2">
                        </div>`;
                }

                return `
                <div class="p-4 bg-${habit.color}-50 rounded-lg">
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="habit${habit.id}" class="mr-3 w-5 h-5">
                        <label for="habit${habit.id}" class="text-lg font-semibold cursor-pointer">${habit.emoji} ${habit.name}</label>
                    </div>
                    ${detailInput}
                </div>
                `;
            }).join('');
        }

        function setCurrentDate() {
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = today.toLocaleDateString('id-ID', options);
            if (document.getElementById('currentDate')) {
                document.getElementById('currentDate').textContent = dateString;
            }
             if (document.getElementById('todayDateForTable')) {
                document.getElementById('todayDateForTable').textContent = today.toLocaleDateString('id-ID');
            }
        }

        function checkSession() {
            const sessionUser = sessionStorage.getItem('currentUser');
            const sessionRole = sessionStorage.getItem('userRole');
            if (sessionUser && sessionRole) {
                currentUser = JSON.parse(sessionUser);
                userRole = sessionRole;
                if (userRole === 'student') {
                    showStudentDashboard();
                } else if (userRole === 'teacher') {
                    showTeacherDashboard();
                }
            }
        }

        // --- NAVIGASI UI & FUNGSI BANTU ---
        function showStudentLogin() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('studentLoginForm').classList.remove('hidden');
        }

        function showTeacherLogin() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('teacherLoginForm').classList.remove('hidden');
        }

        function backToMain() {
            document.getElementById('studentLoginForm').classList.add('hidden');
            document.getElementById('teacherLoginForm').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
        }
        
        function showLoadingSpinner(form, show = true) {
            const spinner = form.querySelector('.loading-spinner');
            const button = form.querySelector('button[type="submit"]');
            if (spinner && button) {
                spinner.classList.toggle('hidden', !show);
                button.disabled = show;
            }
        }

        function showNotification(message, isError = false, duration = 4000) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `fixed top-20 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50 notification ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, duration);
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.add('hidden');
            modal.querySelector('.modal-content').classList.remove('scale-100');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }

        function copyCode() {
            const code = document.getElementById('currentStudentCode').textContent;
            const tempInput = document.createElement('input');
            tempInput.value = code;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            showNotification('Kode unik berhasil disalin!');
        }

        // --- LOGIN & LOGOUT ---
        async function studentLogin(event) {
            event.preventDefault();
            const form = event.target;
            showLoadingSpinner(form);
            
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            let studentCode = document.getElementById('studentCode').value.trim();
            
            if (!studentCode) {
                studentCode = 'S' + Date.now().toString(36).toUpperCase();
            }
            
            const studentId = `${studentCode}-${name.replace(/\s+/g, '')}-${studentClass}`;
            
            currentUser = { name, class: studentClass, uniqueCode: studentCode, id: studentId };
            userRole = 'student';

            try {
                // Cek apakah siswa sudah ada, jika tidak, buat baru
                let { data: student, error } = await window.supabase
                    .from('students')
                    .select('id')
                    .eq('id', studentId)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116: "Hasilnya berisi 0 baris"
                    throw error;
                }

                if (!student) {
                    const { error: insertError } = await window.supabase.from('students').insert({
                        id: studentId,
                        name: currentUser.name,
                        class: currentUser.class,
                        uniqueCode: currentUser.uniqueCode
                    });
                    if (insertError) throw insertError;
                    showNotification(`Selamat datang, ${name}! Kode unikmu adalah ${studentCode}. Simpan baik-baik ya!`);
                }
                
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                sessionStorage.setItem('userRole', userRole);

                showStudentDashboard();

            } catch (error) {
                console.error("Kesalahan login siswa:", error);
                showNotification(`Gagal login: ${error.message}`, true);
            } finally {
                showLoadingSpinner(form, false);
            }
        }

        async function teacherLogin(event) {
            event.preventDefault();
            const form = event.target;
            showLoadingSpinner(form);
            
            const name = document.getElementById('teacherName').value.trim();
            const password = document.getElementById('teacherPassword').value;
            const teacherClass = document.getElementById('teacherClass').value;
            
            if (password !== '@SDN008purnama') {
                showNotification('Password salah! Silakan coba lagi.', true);
                showLoadingSpinner(form, false);
                return;
            }
            
            currentUser = { name, class: teacherClass };
            userRole = 'teacher';

            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            sessionStorage.setItem('userRole', userRole);

            showTeacherDashboard();
            showLoadingSpinner(form, false);
        }

        function logout() {
            if (realtimeChannel) {
                window.supabase.removeChannel(realtimeChannel);
                realtimeChannel = null;
            }
            currentUser = null;
            userRole = null;
            sessionStorage.clear();
            
            document.getElementById('studentDashboard').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.add('hidden');
            document.getElementById('habitsDisplay').classList.remove('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            backToMain();
        }

        // --- DASBOR SISWA ---
        function showStudentDashboard() {
            document.getElementById('studentLoginForm').classList.add('hidden');
            document.getElementById('habitsDisplay').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('studentDashboard').classList.remove('hidden');
            
            document.getElementById('currentStudentName').textContent = currentUser.name;
            document.getElementById('currentStudentClass').textContent = currentUser.class;
            document.getElementById('currentStudentCode').textContent = currentUser.uniqueCode;
            
            loadStudentData();
        }

        async function loadStudentData() {
            const today = new Date().toISOString().split('T')[0];
            const habitId = `${currentUser.id}-${today}`;
            
            try {
                const { data, error } = await window.supabase
                    .from('habits')
                    .select('*')
                    .eq('id', habitId)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                if (data) {
                    // Isi formulir dengan data hari ini
                    HABITS.forEach(habit => {
                        document.getElementById(`habit${habit.id}`).checked = data.habits[habit.id-1];
                        if (habit.details === 'prayer') {
                            const prayerChecks = document.querySelectorAll('.prayer-check');
                            prayerChecks.forEach(pc => pc.checked = false); // Reset dulu
                            if (data.details.prayers) {
                                data.details.prayers.forEach(p => {
                                    const checkbox = document.querySelector(`.prayer-check[data-prayer="${p}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            document.getElementById(`detail${habit.id}`).value = data.details.worshipDetail || '';
                        } else {
                             document.getElementById(`detail${habit.id}`).value = data.details[`detail${habit.id}`] || '';
                        }
                    });
                    document.getElementById('additionalNotes').value = data.notes || '';
                } else {
                    document.getElementById('habitsForm').reset();
                }
            } catch (error) {
                console.error("Gagal memuat kebiasaan hari ini:", error);
            }

            loadStudentHistoryAndProgress();
        }
        
        async function loadStudentHistoryAndProgress() {
            const historyContainer = document.getElementById('studentHistory');
            historyContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Memuat riwayat...</p>';

            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6); // Ambil data 7 hari terakhir
            const sevenDaysAgoString = sevenDaysAgo.toISOString().split('T')[0];

            const { data: historyData, error } = await window.supabase
                .from('habits')
                .select('*')
                .eq('studentId', currentUser.id)
                .gte('date', sevenDaysAgoString)
                .order('date', { ascending: false });

            if (error) {
                console.error("Gagal mengambil riwayat:", error);
                historyContainer.innerHTML = '<p class="text-red-500 text-center py-4">Gagal memuat riwayat.</p>';
                return;
            }

            let historyHTML = '';
            let completedHabits = 0;
            let totalPossibleHabits = 0;

            historyData.forEach(data => {
                const date = new Date(data.date + 'T00:00:00');
                const score = data.score;
                
                completedHabits += score;
                totalPossibleHabits += HABITS.length;

                historyHTML += `
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">${date.toLocaleDateString('id-ID', {weekday: 'long', day: 'numeric', month: 'short'})}</span>
                            <span class="text-lg font-bold ${score === 7 ? 'text-green-600' : score >= 5 ? 'text-yellow-600' : 'text-red-600'}">${score}/${HABITS.length}</span>
                        </div>
                        ${data.notes ? `<p class="text-sm text-gray-600 mt-1 italic">"${data.notes}"</p>` : ''}
                    </div>`;
            });

            historyContainer.innerHTML = historyHTML || '<p class="text-gray-500 text-center py-4">Belum ada riwayat pengisian.</p>';
            
            const progress = totalPossibleHabits > 0 ? Math.round((completedHabits / totalPossibleHabits) * 100) : 0;
            document.getElementById('weeklyProgress').textContent = `${progress}%`;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        async function saveHabits(event) {
            event.preventDefault();
            const today = new Date().toISOString().split('T')[0];
            const habitId = `${currentUser.id}-${today}`;

            const habitChecks = HABITS.map(h => document.getElementById(`habit${h.id}`).checked);
            const score = habitChecks.filter(Boolean).length;
            const prayers = Array.from(document.querySelectorAll('.prayer-check:checked')).map(el => el.dataset.prayer);

            const habitData = {
                id: habitId,
                studentId: currentUser.id,
                studentName: currentUser.name,
                class: currentUser.class,
                date: today,
                habits: habitChecks,
                details: {
                    detail1: document.getElementById('detail1').value,
                    prayers: prayers,
                    worshipDetail: document.getElementById('detail2').value,
                    detail3: document.getElementById('detail3').value,
                    detail4: document.getElementById('detail4').value,
                    detail5: document.getElementById('detail5').value,
                    detail6: document.getElementById('detail6').value,
                    detail7: document.getElementById('detail7').value,
                },
                notes: document.getElementById('additionalNotes').value,
                score: score,
                updatedAt: new Date().toISOString()
            };

            try {
                const { error } = await window.supabase.from('habits').upsert(habitData);
                if (error) throw error;
                showNotification('Jurnal berhasil disimpan! üéâ');
                loadStudentHistoryAndProgress();
            } catch (error) {
                console.error("Gagal menyimpan kebiasaan:", error);
                showNotification(`Gagal menyimpan: ${error.message}`, true);
            }
        }

        // --- DASBOR GURU ---
        function showTeacherDashboard() {
            document.getElementById('teacherLoginForm').classList.add('hidden');
            document.getElementById('habitsDisplay').classList.add('hidden');
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('teacherDashboard').classList.remove('hidden');
            
            document.getElementById('currentTeacherName').textContent = currentUser.name;
            document.getElementById('currentTeacherClass').textContent = currentUser.class;
            
            setupTeacherDashboardListener();
        }

        function setupTeacherDashboardListener() {
            if (realtimeChannel) {
                window.supabase.removeChannel(realtimeChannel);
            }
            
            // Ambil data awal
            fetchTeacherData();

            // Atur langganan realtime
            realtimeChannel = window.supabase.channel('public:habits')
              .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'habits', filter: `class=eq.${currentUser.class}` }, 
                (payload) => {
                    console.log('Perubahan realtime diterima!', payload);
                    fetchTeacherData(); // Ambil ulang semua data saat ada perubahan
                }
              )
              .subscribe();
        }

        async function fetchTeacherData() {
            const { data: students, error: studentsError } = await window.supabase
                .from('students')
                .select('*')
                .eq('class', currentUser.class);

            if (studentsError) {
                console.error("Gagal mengambil data siswa:", studentsError);
                showNotification("Gagal memuat data siswa.", true);
                return;
            }

            const { data: habits, error: habitsError } = await window.supabase
                .from('habits')
                .select('*')
                .eq('class', currentUser.class);

            if (habitsError) {
                console.error("Gagal mengambil data kebiasaan:", habitsError);
                showNotification("Gagal memuat data jurnal.", true);
                return;
            }

            updateTeacherUI(students, habits);
        }

        function updateTeacherUI(students, habits) {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const startOfWeek = getStartOfWeek(today);

            // --- Kartu Statistik ---
            const habitsToday = habits.filter(h => h.date === todayString);
            const activeTodayCount = new Set(habitsToday.map(h => h.studentId)).size;
            const totalScoreToday = habitsToday.reduce((sum, h) => sum + h.score, 0);
            const averageScore = activeTodayCount > 0 ? (totalScoreToday / activeTodayCount).toFixed(1) : 0;
            const consistency = students.length > 0 ? Math.round((activeTodayCount / students.length) * 100) : 0;

            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('activeToday').textContent = activeTodayCount;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('consistency').textContent = `${consistency}%`;

            updateStudentsTable(students, habits, todayString);
            updateLeaderboard(students, habits, startOfWeek);
            updateClassChart(habits, students.length, today);
        }

        function updateStudentsTable(students, allHabits, todayString) {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" class="text-center p-8 text-gray-500">Belum ada siswa di kelas ini.</td></tr>`;
                return;
            }

            students.sort((a, b) => a.name.localeCompare(b.name));

            students.forEach(student => {
                const habitData = allHabits.find(h => h.studentId === student.id && h.date === todayString);
                const score = habitData ? habitData.score : 0;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                let habitCells = '';
                if (habitData) {
                    habitCells = habitData.habits.map(h => `<td class="px-4 py-4 whitespace-nowrap text-sm text-center hidden md:table-cell">${h ? '‚úÖ' : '‚ùå'}</td>`).join('');
                } else {
                    habitCells = `<td colspan="7" class="px-4 py-4 whitespace-nowrap text-sm text-center text-gray-400 hidden md:table-cell">Belum mengisi</td>`;
                }

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.name}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-bold ${score === 7 ? 'text-green-600' : score >= 5 ? 'text-yellow-600' : 'text-red-600'}">${score}/${HABITS.length}</td>
                    ${habitCells}
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center">
                        <button onclick="viewStudentDetail('${student.id}')" class="text-blue-600 hover:text-blue-900">Detail</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateLeaderboard(students, allHabits, startOfWeek) {
            const leaderboardContainer = document.getElementById('leaderboard');
            leaderboardContainer.innerHTML = '';
            
            const studentScores = students.map(student => {
                const weeklyHabits = allHabits.filter(h => h.studentId === student.id && new Date(h.date) >= startOfWeek);
                const totalScore = weeklyHabits.reduce((sum, h) => sum + h.score, 0);
                return { name: student.name, score: totalScore };
            }).sort((a, b) => b.score - a.score);

            if (studentScores.length === 0) {
                 leaderboardContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data untuk ditampilkan.</p>';
                 return;
            }

            studentScores.forEach((student, index) => {
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : `<b>${position}</b>`;
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-3 mb-2 rounded-lg ' + (position <= 3 ? 'bg-yellow-50' : 'bg-gray-50');
                item.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-2xl mr-3 w-8 text-center">${medal}</span>
                        <div class="font-semibold">${student.name}</div>
                    </div>
                    <div class="font-bold text-lg text-yellow-600">${student.score} Poin</div>
                `;
                leaderboardContainer.appendChild(item);
            });
        }

        function updateClassChart(allHabits, studentCount, today) {
            const ctx = document.getElementById('classChart').getContext('2d');
            const labels = [];
            const dataPoints = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('id-ID', {day: '2-digit', month: 'short'}));

                const habitsOnDate = allHabits.filter(h => h.date === dateString);
                const totalScore = habitsOnDate.reduce((sum, h) => sum + h.score, 0);
                
                const averageScore = studentCount > 0 ? totalScore / studentCount : 0;
                dataPoints.push(averageScore.toFixed(2));
            }

            if (classChart) {
                classChart.destroy();
            }

            classChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rata-rata Skor Kepatuhan Kelas',
                        data: dataPoints,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true, max: HABITS.length } }
                }
            });
        }

        async function viewStudentDetail(studentId) {
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            const { data: student, error } = await window.supabase.from('students').select('*').eq('id', studentId).single();

            if (error) {
                showNotification("Data siswa tidak ditemukan.", true);
                return;
            }
            
            modalTitle.textContent = `Detail Jurnal: ${student.name}`;

            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 6);
            const sevenDaysAgoString = sevenDaysAgo.toISOString().split('T')[0];

            let bodyHtml = '<p class="text-center">Memuat data...</p>';
            modalBody.innerHTML = bodyHtml;
            modal.classList.remove('hidden');

            const { data: historyData, error: historyError } = await window.supabase
                .from('habits')
                .select('*')
                .eq('studentId', studentId)
                .gte('date', sevenDaysAgoString)
                .order('date', { ascending: false });

            if (historyError) {
                modalBody.innerHTML = '<p class="text-red-500 text-center">Gagal memuat detail jurnal.</p>';
                return;
            }
            
            bodyHtml = '';
            // Buat map untuk pencarian cepat
            const historyMap = new Map(historyData.map(h => [h.date, h]));

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                
                bodyHtml += `<div class="bg-gray-100 p-4 rounded-lg">`;
                bodyHtml += `<h4 class="font-bold mb-2">${date.toLocaleDateString('id-ID', {weekday: 'long', day: 'numeric', month: 'long'})}</h4>`;

                if (historyMap.has(dateString)) {
                    const data = historyMap.get(dateString);
                    bodyHtml += `<ul class="list-disc list-inside space-y-1">`;
                    HABITS.forEach((habit, index) => {
                        bodyHtml += `<li>${data.habits[index] ? '‚úÖ' : '‚ùå'} ${habit.name}</li>`;
                    });
                    bodyHtml += `</ul>`;
                    if (data.notes) {
                         bodyHtml += `<p class="mt-2 pt-2 border-t border-gray-200 italic"><b>Catatan:</b> "${data.notes}"</p>`;
                    }
                } else {
                    bodyHtml += `<p class="text-gray-500">Tidak ada data untuk tanggal ini.</p>`;
                }
                bodyHtml += `</div>`;
            }

            modalBody.innerHTML = bodyHtml || '<p class="text-center">Tidak ada data jurnal dalam 7 hari terakhir.</p>';
        }
        
        async function exportToExcel() {
            showNotification('Mempersiapkan file Excel...');
            const { data: students, error: studentsError } = await window.supabase
                .from('students')
                .select('id, name')
                .eq('class', currentUser.class);

            if (studentsError) return showNotification('Gagal mengambil data siswa untuk ekspor.', true);

            const { data: habits, error: habitsError } = await window.supabase
                .from('habits')
                .select('*')
                .eq('class', currentUser.class)
                .order('date', { ascending: false });

            if (habitsError) return showNotification('Gagal mengambil data jurnal untuk ekspor.', true);
            
            const excelData = [];
            const habitNames = HABITS.map(h => h.name);
            excelData.push(['Nama Siswa', 'Kelas', 'Tanggal', ...habitNames, 'Total Skor', 'Catatan']);
            
            habits.forEach(habitData => {
                const row = [
                    habitData.studentName,
                    habitData.class,
                    new Date(habitData.date + 'T00:00:00').toLocaleDateString('id-ID'),
                    ...habitData.habits.map(h => h ? 'Ya' : 'Tidak'),
                    habitData.score,
                    habitData.notes || '',
                ];
                excelData.push(row);
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(excelData);
            
            ws['!cols'] = [ { wch: 20 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 10 }, { wch: 30 } ];
            
            XLSX.utils.book_append_sheet(wb, ws, `Kelas ${currentUser.class}`);
            
            const today = new Date().toISOString().split('T')[0];
            const filename = `Jurnal_7_Kebiasaan_Kelas_${currentUser.class}_${today}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            showNotification('File Excel berhasil diunduh! üìä');
        }

        async function exportToPDF() {
            showNotification('Mempersiapkan file PDF...');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const { data: students, error: studentsError } = await window.supabase
                .from('students')
                .select('*')
                .eq('class', currentUser.class);
            if (studentsError) return showNotification('Gagal mengambil data siswa untuk ekspor.', true);

            const today = new Date().toISOString().split('T')[0];
            const { data: habits, error: habitsError } = await window.supabase
                .from('habits')
                .select('*')
                .eq('class', currentUser.class)
                .eq('date', today);
            if (habitsError) return showNotification('Gagal mengambil data jurnal untuk ekspor.', true);

            doc.setFontSize(16);
            doc.text('Laporan Jurnal 7 Kebiasaan Anak Hebat', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Kelas: ${currentUser.class}`, 20, 30);
            doc.text(`Guru: ${currentUser.name}`, 20, 40);
            doc.text(`Tanggal Cetak: ${new Date().toLocaleDateString('id-ID')}`, 20, 50);
            
            const tableData = [];
            const habitNames = ['BP', 'IB', 'OR', 'MS', 'BL', 'BM', 'TC'];
            
            students.sort((a,b) => a.name.localeCompare(b.name)).forEach(student => {
                const habitData = habits.find(h => h.studentId === student.id);
                const score = habitData ? habitData.score : 0;
                const habitChecks = habitData ? habitData.habits.map(h => h ? '‚úÖ' : '‚ùå') : Array(7).fill('‚ùå');
                tableData.push([ student.name, ...habitChecks, `${score}/7` ]);
            });
            
            doc.autoTable({
                head: [['Nama Siswa', ...habitNames, 'Skor']],
                body: tableData,
                startY: 60,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [34, 197, 94] },
                columnStyles: { 0: { cellWidth: 40 }, 8: { cellWidth: 20 } }
            });
            
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text('Keterangan:', 20, finalY);
            doc.text('BP: Bangun Pagi, IB: Beribadah, OR: Berolahraga, MS: Makan Sehat', 20, finalY + 7);
            doc.text('BL: Gemar Belajar, BM: Bermasyarakat, TC: Tidur Cepat', 20, finalY + 14);
            
            const todayStr = new Date().toISOString().split('T')[0];
            const filename = `Laporan_Jurnal_Harian_Kelas_${currentUser.class}_${todayStr}.pdf`;
            
            doc.save(filename);
            showNotification('File PDF berhasil diunduh! üìÑ');
        }

        // --- FUNGSI UTILITAS ---
        function getStartOfWeek(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Sesuaikan jika hari Minggu
            return new Date(new Date(d.setDate(diff)).setHours(0, 0, 0, 0));
        }

        // --- Membuat fungsi dapat diakses secara global ---
        window.showStudentLogin = showStudentLogin;
        window.showTeacherLogin = showTeacherLogin;
        window.backToMain = backToMain;
        window.studentLogin = studentLogin;
        window.teacherLogin = teacherLogin;
        window.logout = logout;
        window.saveHabits = saveHabits;
        window.viewStudentDetail = viewStudentDetail;
        window.closeModal = closeModal;
        window.copyCode = copyCode;
        window.exportToExcel = exportToExcel;
        window.exportToPDF = exportToPDF;

    </script>
</body>
</html>
