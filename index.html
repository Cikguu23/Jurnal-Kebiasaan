<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal 7 Kebiasaan Anak Indonesia Hebat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Konfigurasi Supabase Anda (Ganti dengan kunci proyek Anda)
        const supabaseUrl = 'https://owgdgidtoupnxhgfybzv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im93Z2RnaWR0b3VwbnhoZ2Z5Ynp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NTIxMTksImV4cCI6MjA3MDAzNTI5OH0.g_J9oN34VlV_d106hK1yXQfCq4Y-t19f_t-d-r_d8s';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        window.supabase = supabase;
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #22c55e 0%, #fb923c 100%);
        }
        
        .habit-card {
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }
        
        .habit-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .habit-card:nth-child(2) { animation-delay: 0.5s; }
        .habit-card:nth-child(3) { animation-delay: 1s; }
        .habit-card:nth-child(4) { animation-delay: 1.5s; }
        .habit-card:nth-child(5) { animation-delay: 2s; }
        .habit-card:nth-child(6) { animation-delay: 2.5s; }
        .habit-card:nth-child(7) { animation-delay: 3s; }
        
        .progress-bar {
            transition: width 0.5s ease;
        }
        
        .notification {
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .medal {
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .sync-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sync-online {
            background: #10b981;
            color: white;
        }
        
        .sync-offline {
            background: #ef4444;
            color: white;
        }
        
        .sync-syncing {
            background: #f59e0b;
            color: white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .animated-title {
            background: linear-gradient(-45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #ffeaa7, #dda0dd);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
            display: inline-block;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .animation-delay-300 {
            animation-delay: 0.3s;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="syncIndicator" class="sync-indicator sync-offline">
        üîÑ Menyinkronkan...
    </div>

    <header class="bg-white/10 backdrop-blur-md shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="https://iili.io/FLZp1qP.md.png" alt="Logo Kiri" class="h-12 w-auto">
            </div>
            <h1 class="text-white text-xl font-bold text-center flex-1 animate-pulse">
                <span class="inline-block animate-bounce">üìö</span>
                <span class="animated-title">Jurnal 7 Kebiasaan Anak Indonesia Hebat</span>
                <span class="inline-block animate-bounce animation-delay-300">üåü</span>
            </h1>
            <img src="https://iili.io/FLmkjSI.png" alt="Logo Sekolah" class="h-12 w-auto">
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div id="loginSection" class="max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Masuk ke Jurnal</h2>
                <p class="text-gray-600">Pilih peran Anda untuk melanjutkan</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showStudentLogin()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                    üéì Masuk sebagai Siswa
                </button>
                <button onclick="showTeacherLogin()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                    üë®‚Äçüè´ Masuk sebagai Guru
                </button>
            </div>
        </div>

        <div id="studentLoginForm" class="hidden max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Login Siswa</h3>
            <form onsubmit="studentLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Siswa</label>
                    <input type="text" id="studentName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kelas</label>
                    <select id="studentClass" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500" required>
                        <option value="">Pilih Kelas</option>
                        <option value="1A">1A</option>
                        <option value="1B">1B</option>
                        <option value="1C">1C</option>
                        <option value="2A">2A</option>
                        <option value="2B">2B</option>
                        <option value="2C">2C</option>
                        <option value="2D">2D</option>
                        <option value="3A">3A</option>
                        <option value="3B">3B</option>
                        <option value="3C">3C</option>
                        <option value="3D">3D</option>
                        <option value="4A">4A</option>
                        <option value="4B">4B</option>
                        <option value="4C">4C</option>
                        <option value="4D">4D</option>
                        <option value="5A">5A</option>
                        <option value="5B">5B</option>
                        <option value="5C">5C</option>
                        <option value="6A">6A</option>
                        <option value="6B">6B</option>
                        <option value="6C">6C</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <span class="loading-spinner hidden"></span>
                    Masuk
                </button>
                <button type="button" onclick="backToMain()" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Kembali
                </button>
            </form>
        </div>

        <div id="teacherLoginForm" class="hidden max-w-md mx-auto bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Login Guru</h3>
            <form onsubmit="teacherLogin(event)">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nama Guru</label>
                    <input type="text" id="teacherName" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="teacherPassword" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Kelas yang Diampu</label>
                    <select id="teacherClass" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-green-500" required>
                        <option value="">Pilih Kelas</option>
                        <option value="1A">1A</option>
                        <option value="1B">1B</option>
                        <option value="1C">1C</option>
                        <option value="2A">2A</option>
                        <option value="2B">2B</option>
                        <option value="2C">2C</option>
                        <option value="2D">2D</option>
                        <option value="3A">3A</option>
                        <option value="3B">3B</option>
                        <option value="3C">3C</option>
                        <option value="3D">3D</option>
                        <option value="4A">4A</option>
                        <option value="4B">4B</option>
                        <option value="4C">4C</option>
                        <option value="4D">4D</option>
                        <option value="5A">5A</option>
                        <option value="5B">5B</option>
                        <option value="5C">5C</option>
                        <option value="6A">6A</option>
                        <option value="6B">6B</option>
                        <option value="6C">6C</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    <span class="loading-spinner hidden"></span>
                    Masuk
                </button>
                <button type="button" onclick="backToMain()" class="w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                    Kembali
                </button>
            </form>
        </div>

        <div id="homepageDashboard" class="mb-8">
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8 text-center">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Selamat Datang di Jurnal 7 Kebiasaan</h2>
                <p class="text-lg text-gray-600 mb-6">Membangun karakter anak Indonesia yang hebat melalui kebiasaan positif sehari-hari</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-400 to-blue-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-4xl mb-2">üë•</div>
                        <h3 class="text-2xl font-bold" id="totalRegisteredStudents">0</h3>
                        <p class="text-blue-100">Total Siswa Terdaftar</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-400 to-green-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-4xl mb-2">üìù</div>
                        <h3 class="text-2xl font-bold" id="totalJournalEntries">0</h3>
                        <p class="text-green-100">Total Jurnal Terisi</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-400 to-purple-600 text-white p-6 rounded-xl shadow-lg">
                        <div class="text-4xl mb-2">üèÜ</div>
                        <h3 class="text-2xl font-bold" id="totalMedalsEarned">0</h3>
                        <p class="text-purple-100">Total Medali Diraih</p>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="showStudentLogin()" class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-lg">
                        <div class="text-3xl mb-2">üéì</div>
                        <div class="text-lg">Masuk sebagai Siswa</div>
                        <div class="text-sm opacity-90">Isi jurnal harian Anda</div>
                    </button>
                    
                    <button onclick="showTeacherLogin()" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-4 px-8 rounded-xl transition duration-300 transform hover:scale-105 shadow-lg">
                        <div class="text-3xl mb-2">üë®‚Äçüè´</div>
                        <div class="text-lg">Masuk sebagai Guru</div>
                        <div class="text-sm opacity-90">Pantau progress siswa</div>
                    </button>
                </div>
            </div>
            
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">üåü Siswa Berprestasi Minggu Ini</h3>
                <div id="topPerformers" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>
            </div>
        </div>

        <div id="habitsDisplay" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQAv9Qp.png" alt="Bangun Pagi" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Bangun Pagi</h3>
                <p class="text-sm text-gray-600">Mulai hari dengan semangat</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQAgxRe.png" alt="Beribadah" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Beribadah</h3>
                <p class="text-sm text-gray-600">Mendekatkan diri kepada Allah</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQAgvbs.png" alt="Berolahraga" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Berolahraga</h3>
                <p class="text-sm text-gray-600">Tubuh sehat jiwa kuat</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQArT7t.png" alt="Makan Sehat" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Makan Sehat</h3>
                <p class="text-sm text-gray-600">Nutrisi untuk tumbuh kembang</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQA4GPR.png" alt="Gemar Belajar" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Gemar Belajar</h3>
                <p class="text-sm text-gray-600">Ilmu adalah harta terbesar</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQA4iNe.png" alt="Bermasyarakat" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Bermasyarakat</h3>
                <p class="text-sm text-gray-600">Berbagi kebaikan dengan sesama</p>
            </div>
            
            <div class="habit-card bg-white/90 backdrop-blur-md rounded-2xl p-6 text-center shadow-xl">
                <div class="mb-4 flex justify-center">
                    <img src="https://iili.io/FQA6uxs.png" alt="Tidur Cepat" class="w-16 h-16 object-contain">
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Tidur Cepat</h3>
                <p class="text-sm text-gray-600">Istirahat yang cukup</p>
            </div>
        </div>

        <div id="studentDashboard" class="hidden">
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Siswa</h2>
                    <div class="flex gap-2">
                        <button onclick="syncData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üîÑ Sinkronkan
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            Keluar
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Halo, <span id="currentStudentName"></span>!</h3>
                    <p class="text-gray-600">Kelas: <span id="currentStudentClass"></span></p>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Progress Minggu Ini</span>
                        <span class="text-sm font-medium text-gray-700" id="weeklyProgress">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="progress-bar bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <form id="habitsForm" onsubmit="saveHabits(event)">
                    <h3 class="text-xl font-bold mb-4">Jurnal Hari Ini - <span id="currentDate"></span></h3>
                    
                    <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit1" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">üåÖ Bangun Pagi</label>
                        </div>
                        <input type="time" id="wakeTime" class="ml-8 px-3 py-1 border rounded">
                        <label class="ml-2 text-sm text-gray-600">Jam bangun (opsional)</label>
                    </div>

                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit2" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">ü§≤ Beribadah</label>
                        </div>
                        <div class="ml-8 space-y-2">
                            <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="prayer-check mr-2" data-prayer="subuh">
                                    <span class="text-sm">Subuh</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="prayer-check mr-2" data-prayer="dzuhur">
                                    <span class="text-sm">Dzuhur</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="prayer-check mr-2" data-prayer="ashar">
                                    <span class="text-sm">Ashar</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="prayer-check mr-2" data-prayer="maghrib">
                                    <span class="text-sm">Maghrib</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="prayer-check mr-2" data-prayer="isya">
                                    <span class="text-sm">Isya</span>
                                </label>
                            </div>
                            <input type="text" id="worshipDetail" placeholder="Keterangan tambahan (tahfiz, dll.)" class="w-full px-3 py-1 border rounded mt-2">
                        </div>
                    </div>

                    <div class="mb-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit3" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">üèÉ‚Äç‚ôÇÔ∏è Berolahraga</label>
                        </div>
                        <input type="text" id="exerciseType" placeholder="Jenis olahraga" class="ml-8 px-3 py-1 border rounded w-full max-w-md">
                    </div>

                    <div class="mb-6 p-4 bg-orange-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit4" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">ü•ó Makan Sehat & Bergizi</label>
                        </div>
                        <input type="text" id="healthyFood" placeholder="Menu yang dimakan" class="ml-8 px-3 py-1 border rounded w-full max-w-md">
                    </div>

                    <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit5" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">üìö Gemar Belajar</label>
                        </div>
                        <input type="text" id="studySubject" placeholder="Mata pelajaran yang dipelajari" class="ml-8 px-3 py-1 border rounded w-full max-w-md">
                    </div>

                    <div class="mb-6 p-4 bg-pink-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit6" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">ü§ù Bermasyarakat</label>
                        </div>
                        <input type="text" id="socialActivity" placeholder="Kegiatan sosial yang dilakukan" class="ml-8 px-3 py-1 border rounded w-full max-w-md">
                    </div>

                    <div class="mb-6 p-4 bg-indigo-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="habit7" class="mr-3 w-5 h-5">
                            <label class="text-lg font-semibold">üò¥ Tidur Cepat</label>
                        </div>
                        <input type="time" id="sleepTime" class="ml-8 px-3 py-1 border rounded">
                        <label class="ml-2 text-sm text-gray-600">Jam tidur</label>
                    </div>

                    <div class="mb-6">
                        <label class="block text-lg font-semibold mb-2">üìù Catatan Tambahan</label>
                        <textarea id="additionalNotes" rows="3" class="w-full px-3 py-2 border rounded-lg" placeholder="Ceritakan pengalaman hari ini..."></textarea>
                    </div>

                    <div class="mb-6">
                        <label class="block text-lg font-semibold mb-2">üì∑ Upload Foto (Opsional)</label>
                        <input type="file" id="photoUpload" accept="image/*" class="w-full px-3 py-2 border rounded-lg">
                        <p class="text-sm text-gray-500 mt-1">Maksimal 1MB</p>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-3 px-6 rounded-xl transition duration-300 transform hover:scale-105">
                        üíæ Simpan & Sinkronkan Data
                    </button>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">üìä Riwayat Pengisian</h3>
                    <div id="studentHistory" class="space-y-4">
                        </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">üèÜ Medali & Pencapaian</h3>
                    <div id="studentMedals" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        </div>
                </div>
            </div>
        </div>

        <div id="teacherDashboard" class="hidden">
            <div class="bg-white/95 backdrop-blur-md rounded-2xl shadow-2xl p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Guru</h2>
                    <div class="flex gap-2">
                        <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üìä Export Excel
                        </button>
                        <button onclick="exportToPDF()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üìÑ Export PDF
                        </button>
                        <button onclick="refreshTeacherData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            üîÑ Refresh Data
                        </button>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300">
                            Keluar
                        </button>
                    </div>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-2">Selamat datang, <span id="currentTeacherName"></span>!</h3>
                    <p class="text-gray-600">Kelas: <span id="currentTeacherClass"></span></p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Total Siswa</h4>
                        <p class="text-2xl font-bold text-blue-600" id="totalStudents">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800">Aktif Hari Ini</h4>
                        <p class="text-2xl font-bold text-green-600" id="activeToday">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-yellow-800">Rata-rata Skor</h4>
                        <p class="text-2xl font-bold text-yellow-600" id="averageScore">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800">Siswa Berprestasi</h4>
                        <p class="text-2xl font-bold text-purple-600" id="topStudentName">...</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Tabel Progres Siswa</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jurnal Terisi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Skor Total</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Grafik Rata-rata Skor Kebiasaan</h3>
                    <canvas id="averageHabitChart"></canvas>
                </div>

            </div>
        </div>
    </div>
    
    <div id="notificationContainer" class="fixed bottom-4 right-4 z-50"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <script>
        // Data global dan konfigurasi
        const habits = [
            'Bangun Pagi', 'Beribadah', 'Berolahraga', 'Makan Sehat',
            'Gemar Belajar', 'Bermasyarakat', 'Tidur Cepat'
        ];
        
        let currentStudent = null;
        let currentTeacher = null;
        
        const db = window.supabase;
        
        // Elemen UI
        const loginSection = document.getElementById('loginSection');
        const studentLoginForm = document.getElementById('studentLoginForm');
        const teacherLoginForm = document.getElementById('teacherLoginForm');
        const homepageDashboard = document.getElementById('homepageDashboard');
        const habitsDisplay = document.getElementById('habitsDisplay');
        const studentDashboard = document.getElementById('studentDashboard');
        const teacherDashboard = document.getElementById('teacherDashboard');
        const loadingSpinner = document.querySelector('.loading-spinner');
        const syncIndicator = document.getElementById('syncIndicator');

        // Initial check on load
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginState();
            fetchHomepageStats();
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        });

        // Tampilkan/sembunyikan bagian UI
        function showSection(sectionId) {
            const sections = [loginSection, studentLoginForm, teacherLoginForm, homepageDashboard, habitsDisplay, studentDashboard, teacherDashboard];
            sections.forEach(section => {
                if (section.id === sectionId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        }

        function showStudentLogin() {
            showSection('studentLoginForm');
            homepageDashboard.classList.add('hidden');
        }

        function showTeacherLogin() {
            showSection('teacherLoginForm');
            homepageDashboard.classList.add('hidden');
        }

        function backToMain() {
            showSection('homepageDashboard');
            showSection('habitsDisplay');
            habitsDisplay.classList.remove('hidden');
            loginSection.classList.remove('hidden');
        }

        async function fetchHomepageStats() {
            try {
                const { count: studentsCount } = await db.from('students').select('*', { count: 'exact' });
                const { count: journalCount } = await db.from('journal_entries').select('*', { count: 'exact' });
                const { count: medalCount } = await db.from('medals').select('*', { count: 'exact' });
                
                document.getElementById('totalRegisteredStudents').textContent = studentsCount || 0;
                document.getElementById('totalJournalEntries').textContent = journalCount || 0;
                document.getElementById('totalMedalsEarned').textContent = medalCount || 0;
                
                const { data: topPerformers, error: topError } = await db
                    .from('journal_entries')
                    .select('student_name, student_class, score')
                    .limit(3)
                    .order('created_at', { ascending: false });

                if (topError) {
                    console.error('Error fetching top performers:', topError);
                    return;
                }

                const topPerformersContainer = document.getElementById('topPerformers');
                topPerformersContainer.innerHTML = '';
                if (topPerformers && topPerformers.length > 0) {
                    topPerformers.forEach(performer => {
                        topPerformersContainer.innerHTML += `
                            <div class="flex items-center p-4 bg-gray-100 rounded-xl shadow-md">
                                <span class="text-3xl mr-4">üèÖ</span>
                                <div>
                                    <p class="font-bold text-gray-800">${performer.student_name}</p>
                                    <p class="text-sm text-gray-600">Kelas ${performer.student_class} | Skor: ${performer.score}</p>
                                </div>
                            </div>
                        `;
                    });
                }
            } catch (error) {
                console.error('Error fetching homepage stats:', error);
            }
        }
        
        async function checkLoginState() {
            const student = await localforage.getItem('currentStudent');
            const teacher = await localforage.getItem('currentTeacher');
            
            if (student) {
                currentStudent = student;
                showStudentDashboard();
            } else if (teacher) {
                currentTeacher = teacher;
                showTeacherDashboard();
            } else {
                showSection('homepageDashboard');
                habitsDisplay.classList.remove('hidden');
                loginSection.classList.remove('hidden');
            }
        }

        async function studentLogin(event) {
            event.preventDefault();
            
            const studentName = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            
            const { data, error } = await db.from('students').select('*').eq('student_name', studentName).eq('student_class', studentClass);
            
            if (error) {
                console.error('Error during student login:', error);
                alert('Terjadi kesalahan saat login.');
                return;
            }

            if (data.length > 0) {
                currentStudent = data[0];
                await localforage.setItem('currentStudent', currentStudent);
                alert('Login berhasil!');
                showStudentDashboard();
            } else {
                const { data: newData, error: newError } = await db.from('students').insert([{
                    student_name: studentName,
                    student_class: studentClass
                }]).select();

                if (newError) {
                    console.error('Error registering new student:', newError);
                    alert('Gagal mendaftarkan siswa baru.');
                    return;
                }
                currentStudent = newData[0];
                await localforage.setItem('currentStudent', currentStudent);
                alert('Siswa baru berhasil didaftarkan dan login!');
                showStudentDashboard();
            }
        }

        async function teacherLogin(event) {
            event.preventDefault();
            const teacherName = document.getElementById('teacherName').value.trim();
            const teacherPassword = document.getElementById('teacherPassword').value.trim();
            const teacherClass = document.getElementById('teacherClass').value;
            
            // Logika login guru (hardcoded atau dari DB 'teachers')
            if (teacherName === 'admin' && teacherPassword === 'password123' && teacherClass) {
                currentTeacher = { teacher_name: teacherName, teacher_class: teacherClass };
                await localforage.setItem('currentTeacher', currentTeacher);
                alert('Login guru berhasil!');
                showTeacherDashboard();
            } else {
                alert('Nama pengguna, password, atau kelas salah.');
            }
        }

        function logout() {
            localforage.clear().then(() => {
                currentStudent = null;
                currentTeacher = null;
                alert('Anda telah keluar.');
                window.location.reload();
            });
        }

        async function showStudentDashboard() {
            showSection('studentDashboard');
            document.getElementById('currentStudentName').textContent = currentStudent.student_name;
            document.getElementById('currentStudentClass').textContent = currentStudent.student_class;
            await fetchStudentData();
        }

        async function fetchStudentData() {
            const today = new Date().toISOString().split('T')[0];
            const { data: journalEntries, error } = await db
                .from('journal_entries')
                .select('*')
                .eq('student_id', currentStudent.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error fetching journal entries:', error);
                return;
            }

            // Tampilkan riwayat
            const historyContainer = document.getElementById('studentHistory');
            historyContainer.innerHTML = '';
            if (journalEntries.length > 0) {
                journalEntries.forEach(entry => {
                    historyContainer.innerHTML += `
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <p class="font-semibold">${new Date(entry.created_at).toLocaleDateString()}</p>
                            <p>Skor: ${entry.score} / 7</p>
                            <p class="text-sm text-gray-600">${entry.additional_notes || ''}</p>
                        </div>
                    `;
                });
            } else {
                historyContainer.innerHTML = '<p class="text-gray-500">Belum ada riwayat jurnal.</p>';
            }

            // Hitung progres mingguan dan medali
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weeklyEntries = journalEntries.filter(entry => new Date(entry.created_at) >= oneWeekAgo);
            const totalScore = weeklyEntries.reduce((sum, entry) => sum + entry.score, 0);
            const maxScore = weeklyEntries.length * 7;
            const progress = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;
            
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('weeklyProgress').textContent = `${progress}%`;

            // Cek medali
            const { data: medals, error: medalError } = await db.from('medals').select('*').eq('student_id', currentStudent.id);
            if (medalError) {
                console.error('Error fetching medals:', medalError);
                return;
            }
            
            const medalsContainer = document.getElementById('studentMedals');
            medalsContainer.innerHTML = '';
            if (medals.length > 0) {
                medals.forEach(medal => {
                    medalsContainer.innerHTML += `
                        <div class="bg-yellow-100 p-4 rounded-lg text-center">
                            <span class="text-3xl medal">${medal.emoji}</span>
                            <p class="font-semibold mt-2">${medal.name}</p>
                        </div>
                    `;
                });
            } else {
                medalsContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Belum ada medali.</p>';
            }
        }
        
        async function saveHabits(event) {
            event.preventDefault();
            loadingSpinner.classList.remove('hidden');
            
            const today = new Date().toISOString().split('T')[0];
            const habitsForm = document.getElementById('habitsForm');
            const formData = new FormData(habitsForm);

            const habits = {
                bangun_pagi: document.getElementById('habit1').checked,
                beribadah: document.getElementById('habit2').checked,
                berolahraga: document.getElementById('habit3').checked,
                makan_sehat: document.getElementById('habit4').checked,
                gemar_belajar: document.getElementById('habit5').checked,
                bermasyarakat: document.getElementById('habit6').checked,
                tidur_cepat: document.getElementById('habit7').checked,
                wake_time: document.getElementById('wakeTime').value,
                worship_details: document.getElementById('worshipDetail').value,
                prayers: Array.from(document.querySelectorAll('.prayer-check:checked')).map(el => el.dataset.prayer),
                exercise_type: document.getElementById('exerciseType').value,
                healthy_food: document.getElementById('healthyFood').value,
                study_subject: document.getElementById('studySubject').value,
                social_activity: document.getElementById('socialActivity').value,
                sleep_time: document.getElementById('sleepTime').value,
                additional_notes: document.getElementById('additionalNotes').value
            };
            
            let score = 0;
            if (habits.bangun_pagi) score++;
            if (habits.beribadah) score++;
            if (habits.berolahraga) score++;
            if (habits.makan_sehat) score++;
            if (habits.gemar_belajar) score++;
            if (habits.bermasyarakat) score++;
            if (habits.tidur_cepat) score++;
            
            // Simpan data ke Supabase
            const { error: saveError } = await db.from('journal_entries').upsert([{
                student_id: currentStudent.id,
                student_name: currentStudent.student_name,
                student_class: currentStudent.student_class,
                entry_date: today,
                score: score,
                ...habits,
                // tambahkan kolom lain jika ada
            }], { onConflict: 'student_id, entry_date' });
            
            loadingSpinner.classList.add('hidden');
            
            if (saveError) {
                console.error('Error saving data:', saveError);
                alert('Gagal menyimpan data. Coba lagi.');
            } else {
                alert('Jurnal berhasil disimpan!');
                habitsForm.reset();
                fetchStudentData(); // Refresh data student
            }
        }
        
        async function showTeacherDashboard() {
            showSection('teacherDashboard');
            document.getElementById('currentTeacherName').textContent = currentTeacher.teacher_name;
            document.getElementById('currentTeacherClass').textContent = currentTeacher.teacher_class;
            await fetchTeacherData();
        }

        let teacherStudentData = [];
        let habitChartInstance = null;

        async function fetchTeacherData() {
            const { data: students, error: studentError } = await db
                .from('students')
                .select('*')
                .eq('student_class', currentTeacher.teacher_class);
            
            if (studentError) {
                console.error('Error fetching students:', studentError);
                return;
            }

            document.getElementById('totalStudents').textContent = students.length;

            const { data: journalEntries, error: journalError } = await db
                .from('journal_entries')
                .select('*')
                .eq('student_class', currentTeacher.teacher_class);
            
            if (journalError) {
                console.error('Error fetching journal entries:', journalError);
                return;
            }

            teacherStudentData = students.map(student => {
                const studentEntries = journalEntries.filter(entry => entry.student_id === student.id);
                const totalScore = studentEntries.reduce((sum, entry) => sum + entry.score, 0);
                const todayEntry = studentEntries.find(entry => entry.entry_date === new Date().toISOString().split('T')[0]);
                return {
                    ...student,
                    total_score: totalScore,
                    journal_count: studentEntries.length,
                    active_today: !!todayEntry,
                };
            });
            
            renderStudentTable();
            renderAverageHabitChart(journalEntries);
            updateTeacherStats(teacherStudentData);
        }
        
        function updateTeacherStats(data) {
            const today = new Date().toISOString().split('T')[0];
            const activeTodayCount = data.filter(s => s.active_today).length;
            const totalScoreSum = data.reduce((sum, s) => sum + s.total_score, 0);
            const averageScore = data.length > 0 ? (totalScoreSum / data.length).toFixed(2) : 0;
            const topStudent = data.sort((a, b) => b.total_score - a.total_score)[0];
            
            document.getElementById('activeToday').textContent = activeTodayCount;
            document.getElementById('averageScore').textContent = averageScore;
            document.getElementById('topStudentName').textContent = topStudent ? topStudent.student_name : 'N/A';
        }
        
        function renderStudentTable() {
            const tableBody = document.getElementById('studentTableBody');
            tableBody.innerHTML = '';
            teacherStudentData.forEach(student => {
                tableBody.innerHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${student.student_name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.student_class}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.journal_count}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${student.total_score}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="viewStudentDetail('${student.id}')" class="text-indigo-600 hover:text-indigo-900">Lihat Detail</button>
                        </td>
                    </tr>
                `;
            });
        }
        
        function renderAverageHabitChart(journalEntries) {
            if (habitChartInstance) {
                habitChartInstance.destroy();
            }

            const habitScores = {
                'Bangun Pagi': [], 'Beribadah': [], 'Berolahraga': [], 'Makan Sehat': [],
                'Gemar Belajar': [], 'Bermasyarakat': [], 'Tidur Cepat': []
            };

            journalEntries.forEach(entry => {
                if (entry.bangun_pagi) habitScores['Bangun Pagi'].push(1);
                if (entry.beribadah) habitScores['Beribadah'].push(1);
                if (entry.berolahraga) habitScores['Berolahraga'].push(1);
                if (entry.makan_sehat) habitScores['Makan Sehat'].push(1);
                if (entry.gemar_belajar) habitScores['Gemar Belajar'].push(1);
                if (entry.bermasyarakat) habitScores['Bermasyarakat'].push(1);
                if (entry.tidur_cepat) habitScores['Tidur Cepat'].push(1);
            });

            const labels = Object.keys(habitScores);
            const data = labels.map(label => {
                const total = habitScores[label].length;
                return total > 0 ? (total / journalEntries.length * 100).toFixed(2) : 0;
            });

            const ctx = document.getElementById('averageHabitChart').getContext('2d');
            habitChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Persentase Pengisian Jurnal (%)',
                        data: data,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED'
                        ],
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                        }
                    }
                }
            });
        }
        
        function refreshTeacherData() {
            fetchTeacherData();
            alert('Data telah diperbarui.');
        }

        async function exportToExcel() {
            const worksheet = XLSX.utils.json_to_sheet(teacherStudentData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Siswa");
            XLSX.writeFile(workbook, "Data_Siswa_Kelas_" + currentTeacher.teacher_class + ".xlsx");
        }

        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Data Siswa Kelas ${currentTeacher.teacher_class}`, 14, 20);

            const tableData = teacherStudentData.map(student => [
                student.student_name,
                student.student_class,
                student.journal_count,
                student.total_score
            ]);

            doc.autoTable({
                head: [['Nama Siswa', 'Kelas', 'Jurnal Terisi', 'Skor Total']],
                body: tableData,
                startY: 30,
            });

            doc.save(`Data_Siswa_Kelas_${currentTeacher.teacher_class}.pdf`);
        }

        // Dummy function for view student detail
        function viewStudentDetail(studentId) {
            alert(`Melihat detail siswa dengan ID: ${studentId}`);
            // Tambahkan logika untuk menampilkan detail siswa
        }
    </script>

</body>
</html>
